use clap::{App, Arg};
use dirs::desktop_dir;

fn main() -> Result<(), Box<dyn std::error::Error>> {
    dotenv().ok(); // Load .env file
    print_banner();

    let default_path = desktop_dir()
        .expect("Could not find desktop directory")
        .to_str()
        .expect("Desktop path is not valid UTF-8")
        .to_string();

    let matches = App::new("Genesis")
        .version("1.0")
        .author("Your Name")
        .about("Sets up starter projects for Go or Rust")
        .arg(Arg::new("language")
            .short('l')
            .long("language")
            .value_name("LANGUAGE")
            .help("Sets the project language (go or rust)")
            .takes_value(true))
        .arg(Arg::new("path")
            .short('p')
            .long("path")
            .value_name("PATH")
            .help("Sets the path where the project will be cloned")
            .default_value(&default_path)
            .takes_value(true))
        .get_matches();

    let language = match matches.value_of("language") {
        Some(lang) => lang.to_string(),
        None => get_language_selection()?,
    };

    let path = matches.value_of("path").unwrap().to_string();

    match language.as_str() {
        "go" => setup_go_project(&path)?,
        "rust" => setup_rust_project(&path)?,
        _ => println!("{}", style(format!("Unsupported language: {}", language)).red()),
    }

    Ok(())
}



fn setup_go_project(base_path: &str) -> Result<(), Box<dyn std::error::Error>> {
    println!("{}", style("Setting up Go project...").yellow());
    
    let project_path = Path::new(base_path).join("go-project");
    println!("{}", style(format!("Cloning repository to {}...", project_path.display())).cyan());
    
    let _repo = clone_repo(
        "https://github.com/yourusername/private-go-starter.git",
        project_path.to_str().unwrap()
    )?;

    println!("{}", style("Running setup commands...").cyan());
    Command::new("go")
        .arg("mod")
        .arg("tidy")
        .current_dir(&project_path)
        .status()?;

    println!("{}", style("Go project set up successfully!").green().bold());
    Ok(())
}

fn setup_rust_project(base_path: &str) -> Result<(), Box<dyn std::error::Error>> {
    println!("{}", style("Setting up Rust project...").yellow());
    
    let project_path = Path::new(base_path).join("rust-project");
    println!("{}", style(format!("Cloning repository to {}...", project_path.display())).cyan());
    
    let _repo = clone_repo(
        "https://github.com/yourusername/private-rust-starter.git",
        project_path.to_str().unwrap()
    )?;

    println!("{}", style("Running setup commands...").cyan());
    Command::new("cargo")
        .arg("build")
        .current_dir(&project_path)
        .status()?;

    println!("{}", style("Rust project set up successfully!").green().bold());
    Ok(())
}